server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # Training logs - 학습 관련 로그
  - job_name: training
    static_configs:
      - targets:
          - localhost
        labels:
          job: training
          service: mlops
          log_type: training
          __path__: /logs/training/*.log
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            epoch: epoch
            step: step
            loss: loss
            learning_rate: learning_rate
      - labels:
          level:
          step:
      - timestamp:
          source: timestamp
          format: RFC3339

  # Inference logs - 추론 관련 로그
  - job_name: inference
    static_configs:
      - targets:
          - localhost
        labels:
          job: inference
          service: mlops
          log_type: inference
          __path__: /logs/inference/*.log
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            request_id: request_id
            latency_ms: latency_ms
            tokens_generated: tokens_generated
      - labels:
          level:
          request_id:
      - timestamp:
          source: timestamp
          format: RFC3339

  # System logs - 시스템 로그
  - job_name: system
    static_configs:
      - targets:
          - localhost
        labels:
          job: system
          service: mlops
          log_type: system
          __path__: /logs/system/*.log
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            gpu_id: gpu_id
            gpu_memory_used: gpu_memory_used
            gpu_utilization: gpu_utilization
      - labels:
          level:
          gpu_id:
      - timestamp:
          source: timestamp
          format: RFC3339

  # MLflow logs
  - job_name: mlflow
    static_configs:
      - targets:
          - localhost
        labels:
          job: mlflow
          service: mlops
          log_type: mlflow
          __path__: /logs/mlflow/*.log

  # vLLM logs
  - job_name: vllm
    static_configs:
      - targets:
          - localhost
        labels:
          job: vllm
          service: mlops
          log_type: vllm
          __path__: /logs/vllm/*.log

  # FastAPI logs
  - job_name: fastapi
    static_configs:
      - targets:
          - localhost
        labels:
          job: fastapi
          service: mlops
          log_type: api
          __path__: /logs/fastapi/*.log
    pipeline_stages:
      - json:
          expressions:
            timestamp: timestamp
            level: level
            message: message
            method: method
            path: path
            status_code: status_code
            duration_ms: duration_ms
      - labels:
          level:
          method:
          status_code:
      - timestamp:
          source: timestamp
          format: RFC3339

  # Docker container logs
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: label
            values: ["com.docker.compose.project=mlops-project"]
    relabel_configs:
      # 컨테이너 이름에서 서비스명 추출
      - source_labels: ['__meta_docker_container_name']
        regex: '/mlops-(.*)'
        target_label: 'container'
      - source_labels: ['__meta_docker_container_name']
        regex: '/mlops-(.*)'
        target_label: 'service'
      - source_labels: ['__meta_docker_container_log_stream']
        target_label: 'stream'
      # Docker Compose 라벨
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        target_label: 'compose_service'
      - source_labels: ['__meta_docker_container_label_com_docker_compose_project']
        target_label: 'compose_project'
    pipeline_stages:
      # JSON 로그 파싱 시도
      - json:
          expressions:
            level: level
            message: message
            timestamp: timestamp
            request_id: request_id
      - labels:
          level:
      - timestamp:
          source: timestamp
          format: RFC3339
          fallback_formats:
            - "2006-01-02T15:04:05.000000"
            - "2006-01-02 15:04:05"