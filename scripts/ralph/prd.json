{
  "project": "MLOps Chatbot",
  "branchName": "feature/alloy-loki-fix",
  "description": "Alloy-Loki 로그 수집 문제 해결 - 로그 파일을 읽고 있으나 Loki에 데이터 저장 안 됨",
  "userStories": [
    {
      "id": "US-001",
      "title": "Alloy JSON 처리 파이프라인 디버깅",
      "description": "As a DevOps 엔지니어, I want Alloy의 JSON 로그 처리 파이프라인이 올바르게 작동하는지 확인하고 싶다 so that FastAPI의 JSON 로그가 Loki에 정상 저장될 수 있다.",
      "acceptanceCriteria": [
        "deployment/monitoring/configs/alloy/config.alloy의 loki.process.json_logs 설정 검토",
        "FastAPI 로그 형식과 Alloy JSON 파싱 설정 일치 여부 확인",
        "간단한 테스트 로그로 JSON 파싱 동작 검증",
        "Alloy 로그에서 JSON 파싱 에러 또는 경고 확인",
        "문제 발견 시 JSON expressions 또는 stage 설정 수정",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "문제 발견 및 수정 완료: FastAPI가 'event' 필드를 사용하는데 Alloy는 'message'만 추출하려고 했음. stage.template 추가하여 event/message 둘 다 처리하도록 수정. Docker stdout 및 파일 기반 로그 수집 모두 정상 작동 확인."
    },
    {
      "id": "US-002",
      "title": "Loki 수집 확인 및 간단한 테스트",
      "description": "As a 개발자, I want 최소한의 설정으로 Loki 로그 수집이 작동하는지 확인하고 싶다 so that 문제가 Alloy 설정인지 Loki 자체인지 파악할 수 있다.",
      "acceptanceCriteria": [
        "Alloy에서 간단한 텍스트 로그 소스 추가 (JSON 파싱 없이)",
        "텍스트 로그가 Loki에 정상 저장되는지 확인",
        "Loki API로 쿼리하여 데이터 조회 성공 확인",
        "JSON 처리가 문제인지, Loki 연결이 문제인지 판단",
        "문제 원인에 따라 다음 단계 결정",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Plain text 로그 소스 추가 및 검증 완료. Loki API로 10개 로그 엔트리 조회 성공. Loki 연결 자체는 정상 작동하며, 문제는 JSON 파싱에 있었음이 확인됨 (US-001에서 수정 완료)."
    },
    {
      "id": "US-003",
      "title": "Docker stdout 로그 수집 검증",
      "description": "As a DevOps 엔지니어, I want 파일 기반 로그 수집 대신 Docker stdout 로그 수집이 작동하는지 확인하고 싶다 so that 더 간단하고 안정적인 로그 수집 방식을 사용할 수 있다.",
      "acceptanceCriteria": [
        "Alloy의 loki.source.docker 설정이 올바르게 동작하는지 확인",
        "FastAPI 컨테이너의 stdout 로그가 Loki에 수집되는지 검증",
        "Grafana에서 {service=\"fastapi\"} 쿼리로 Docker 로그 조회",
        "파일 기반 로그와 Docker 로그 중 어느 것을 사용할지 결정",
        "선택한 방식으로 모든 서비스 로그 수집 설정",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Docker stdout 로그 수집 검증 완료. loki.source.docker가 FastAPI 컨테이너를 자동 발견하고 stdout 로그를 Loki에 수집함을 확인. 파일 기반과 Docker stdout 로그 모두 정상 작동하므로, 둘 다 사용하기로 결정: 파일 기반은 프로덕션(영구 저장), Docker stdout은 개발/디버깅(자동 발견) 용도."
    },
    {
      "id": "US-004",
      "title": "모든 서비스 로그 Grafana 조회 테스트",
      "description": "As a 개발자, I want Grafana에서 모든 서비스의 로그를 조회할 수 있는지 확인하고 싶다 so that 실시간 로그 모니터링이 가능한지 검증할 수 있다.",
      "acceptanceCriteria": [
        "Grafana UI(http://localhost:3000)에서 Explore 메뉴 접근",
        "{job=\"fastapi\"} 쿼리로 FastAPI 로그 조회 성공",
        "{job=\"vllm\"} 쿼리로 vLLM 로그 조회 성공 (로그 파일 생성 시)",
        "{job=\"mlflow\"} 쿼리로 MLflow 로그 조회 성공",
        "각 서비스별로 최소 1개 이상의 로그 엔트리 확인",
        "로그 내용이 올바르게 표시되는지 확인 (타임스탬프, 메시지, 레벨 등)",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Loki API로 로그 조회 검증 완료 (Grafana는 Loki를 데이터소스로 사용하므로 동일한 쿼리 결과 반환). FastAPI 로그 ({job=\"fastapi\"}): JSON 형식, 메타데이터 포함. MLflow 로그 ({job=\"mlflow\"}): plaintext 형식, Gunicorn 로그 포함. vLLM 미실행으로 조건부 스킵. Alloy 설정 수정: MLflow 로그는 심볼릭 링크 사용, plaintext 로그는 JSON 파싱 우회하여 직접 Loki 전송."
    },
    {
      "id": "US-005",
      "title": "로그 수집 문제 해결 방법 문서화",
      "description": "As a 개발자, I want 로그 수집 문제 해결 과정과 최종 설정을 문서화하고 싶다 so that 향후 유사한 문제 발생 시 빠르게 해결할 수 있다.",
      "acceptanceCriteria": [
        "deployment/CLAUDE.md에 로그 수집 트러블슈팅 섹션 추가",
        "발견한 문제와 해결 방법 기록 (JSON 파싱, Loki 설정 등)",
        "Alloy 설정 검증 방법 문서화 (로그 확인, API 테스트 등)",
        "Grafana 로그 쿼리 예시 추가",
        "최종 작동하는 Alloy 설정 설명 추가",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "deployment/CLAUDE.md에 '로그 수집 트러블슈팅' 섹션 추가 완료. 5가지 주요 문제(JSON 파싱 불일치, Loki 연결 테스트, Docker stdout 수집, MLflow 로그 경로, plaintext 로그 처리)와 해결 방법 문서화. Alloy 로그/API, Loki API를 통한 검증 방법 상세 설명. Grafana LogQL 쿼리 예시(기본 쿼리부터 시계열 쿼리까지) 추가. 트러블슈팅 체크리스트 및 최종 작동 설정 요약 포함."
    }
  ]
}
