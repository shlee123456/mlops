# Ralph Progress Log
Started: Wed Jan 28 03:29:39 PM KST 2026
---

## 2026-01-28 15:34 - US-001
- Alloy JSON 파싱 파이프라인에서 FastAPI 로그의 "event" 필드가 누락되어 Loki에 데이터가 저장되지 않던 문제 발견 및 수정
- Files changed:
  - deployment/monitoring/configs/alloy/config.alloy
- **Learnings for future iterations:**
  - FastAPI는 structlog를 사용하여 "event" 필드에 메시지를 저장하는데, 일반적인 로그 포맷은 "message" 필드 사용
  - Alloy의 `stage.json`에서 필드를 추출할 때, 로그 포맷과 정확히 일치해야 함
  - `stage.template`을 사용하면 여러 필드 중 하나를 선택하여 output으로 매핑 가능
  - Loki instant query(`/loki/api/v1/query`)는 in-memory 버퍼만 조회하므로, 과거 데이터는 query_range 사용 필요
  - Alloy는 파일 끝(EOF)에서 tailing을 시작하므로, 기존 로그는 수집되지 않고 새 로그만 수집됨
  - Docker logs와 file-based logs 모두 정상 작동 확인 (각각 다른 label 사용)
  - JSON 필드 추출 확인 방법: Loki API의 stream 객체에서 labels 확인
---
## 2026-01-28 15:43 - US-002
- Added plaintext log source to Alloy config to verify basic Loki connectivity without JSON processing
- Created test log file with 10 entries and verified collection
- Successfully queried Loki API and retrieved all 10 log entries with correct labels
- Files changed:
  - deployment/monitoring/configs/alloy/config.alloy (added test_plaintext source)
- **Learnings for future iterations:**
  - Loki basic connectivity works perfectly - the issue was JSON processing (fixed in US-001)
  - Bypassing loki.process and sending directly to loki.write.default.receiver works for plain text
  - Loki API query_range format: `?query={job="test"}&limit=100&start=<ns>&end=<ns>`
  - Labels are correctly extracted from the targets configuration in loki.source.file
  - Test log sources should forward directly to loki.write.default.receiver to isolate from processing pipelines
  - Alloy config reload requires container restart (docker restart mlops-alloy)
---
## 2026-02-04 03:32 - US-003
- Verified Docker stdout log collection works correctly with loki.source.docker
- FastAPI container stdout logs collected successfully with labels: container="fastapi", compose_service="fastapi-server"
- Confirmed both file-based and Docker stdout log collection methods work properly
- Decision: Use both log collection methods (each has advantages)
  - File-based ({job="fastapi"}): Persistent storage, survives container restarts → Production
  - Docker stdout ({container="fastapi"}): Auto-discovery, no volume mounts → Development/Debugging
- **Learnings for future iterations:**
  - Alloy and Loki should be restarted together when troubleshooting log collection issues (docker restart mlops-loki mlops-alloy)
  - Alloy's discovery.docker.containers successfully discovers containers with label filter: com.docker.compose.project=docker
  - loki.source.docker forwards to loki.process.docker_json for JSON parsing (same as file logs)
  - Docker container labels are automatically extracted and added as Loki labels (container, service, compose_service, compose_project)
  - Query examples:
    - File-based logs: {job="fastapi"}
    - Docker stdout logs: {container="fastapi"} or {compose_service="fastapi-server"}
  - Both methods use the same JSON parsing pipeline (loki.process) so log format is consistent
  - Loki retention/data cleared on restart - normal for development, configure retention for production
---
## 2026-02-04 03:51 - US-004
- Successfully verified log query functionality via Loki API (equivalent to Grafana queries)
- FastAPI logs: {job="fastapi"} query returns JSON logs with full metadata (method, path, status_code, duration_ms, request_id, etc.)
- MLflow logs: {job="mlflow"} query returns plaintext logs (Gunicorn startup messages, worker processes)
- vLLM logs: Service not running, skipped (conditional acceptance criteria)
- Both services show proper timestamps, log levels, and structured content
- Files changed:
  - deployment/monitoring/configs/alloy/config.alloy (MLflow log path to support symlink, changed forward_to for plaintext logs)
- **Learnings for future iterations:**
  - Alloy's loki.source.file requires exact file paths or existing glob patterns, not stat-compatible wildcards
  - MLflow logs use timestamped filenames (mlflow_YYYYMMDD_HHMMSS.log), requiring symlink to mlflow.log for consistent collection
  - Plaintext logs (MLflow, vLLM) should forward directly to loki.write.default.receiver, not through JSON processing
  - Create symlinks inside the container that generates the logs (docker exec) to ensure proper ownership and persistence
  - Loki API queries ({job="service"}) return the same data that Grafana Explore would show - verifying API queries validates Grafana functionality
  - After Loki/Alloy restarts, wait ~10-15 seconds for log collection to stabilize before querying
  - Loki instant query (/loki/api/v1/query) is sufficient for testing recent logs, no need for query_range
---
## 2026-02-04 03:55 - US-005
- Documented all log collection troubleshooting steps in deployment/CLAUDE.md
- Added comprehensive troubleshooting section covering all issues discovered in US-001 through US-004:
  - Problem 1: FastAPI JSON log field mismatch (event vs message) - solved with stage.template
  - Problem 2: Loki connection testing with plaintext logs
  - Problem 3: Docker stdout log collection verification
  - Problem 4: MLflow log file path mismatch - solved with symlinks
  - Problem 5: Plaintext logs bypassing JSON parsing
- Documented Alloy configuration verification methods (logs, Loki API, Alloy HTTP API)
- Added Grafana LogQL query examples (basic, filters, JSON extraction, time series)
- Created troubleshooting checklist with step-by-step commands
- Summarized final working Alloy configuration architecture
- Files changed:
  - deployment/CLAUDE.md (added "로그 수집 트러블슈팅" section)
- **Learnings for future iterations:**
  - Comprehensive troubleshooting documentation should cover: problem symptoms, root cause analysis, solution steps, and verification commands
  - Include real command examples with expected outputs for each verification step
  - Document both working and non-working configurations to help future debugging
  - Grafana query examples should progress from basic to advanced (labels → filters → JSON → time series)
  - Troubleshooting checklist should follow logical order: service → files → Alloy → Loki → data verification
  - For each common problem, document multiple solution approaches (e.g., symlinks vs wildcards vs script changes)
---
